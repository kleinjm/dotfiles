# frozen_string_literal: true

require 'rails_helper'

RSpec.describe LegalOwnershipForm do
  it 'sets up form with legal entity and normalized phone number' do
    organization = create(:organization)
    escrow = create(:escrow, organization: organization)
    legal_entity = create(:legal_entity, :corporation, escrow: escrow, customer_type: 'buyer')

    form = described_class.new(
      legal_entity: legal_entity,
      relationship_type: LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory],
      ownership_params: {
        first_name: 'John',
        last_name: 'Signatory',
        email: 'john.signatory@example.com',
        phone_number: '555-123-4567'
      }
    )

    expect(form.legal_entity).to eq(legal_entity)
    expect(form.relationship_type).to eq(LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory])
    expect(form.escrow).to eq(escrow)
    expect(form.first_name).to eq('John')
    expect(form.last_name).to eq('Signatory')
    expect(form.email).to eq('john.signatory@example.com')
    expect(form.phone_number).to eq('+15551234567')
  end

  it 'validates presence of all required fields' do
    organization = create(:organization)
    escrow = create(:escrow, organization: organization)
    legal_entity = create(:legal_entity, :corporation, escrow: escrow, customer_type: 'buyer')

    form = described_class.new(
      legal_entity: legal_entity,
      relationship_type: LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory],
      ownership_params: {
        first_name: '',
        last_name: '',
        email: 'invalid-email',
        phone_number: ''
      }
    )

    expect(form).not_to be_valid
    expect(form.errors[:first_name]).to include("can't be blank")
    expect(form.errors[:last_name]).to include("can't be blank")
    expect(form.errors[:email]).to include('is invalid')
    expect(form.errors[:phone_number]).to include("can't be blank")
  end

  it 'normalizes phone number formats' do
    organization = create(:organization)
    escrow = create(:escrow, organization: organization)
    legal_entity = create(:legal_entity, :corporation, escrow: escrow, customer_type: 'buyer')

    form = described_class.new(
      legal_entity: legal_entity,
      relationship_type: LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory],
      ownership_params: { phone_number: '(555) 123-4567' }
    )

    expect(form.phone_number).to eq('+15551234567')

    form2 = described_class.new(
      legal_entity: legal_entity,
      relationship_type: LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory],
      ownership_params: { phone_number: nil }
    )

    expect(form2.phone_number).to be_nil
  end

  it 'saves successfully with valid data by calling service' do
    organization = create(:organization)
    escrow = create(:escrow, organization: organization)
    legal_entity = create(:legal_entity, :corporation, escrow: escrow, customer_type: 'buyer')

    form = described_class.new(
      legal_entity: legal_entity,
      relationship_type: LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory],
      ownership_params: {
        first_name: 'John',
        last_name: 'Signatory',
        email: 'john.signatory@example.com',
        phone_number: '555-123-4567'
      }
    )

    expect(form.save).to be_truthy
    expect(form.ownership_record).to be_a(LegalOwnership)
    expect(form.ownership_record.customer).to be_a(Buyer)
    expect(form.ownership_record.legal_entity).to eq(legal_entity)
  end

  it 'returns false for invalid form without calling service' do
    organization = create(:organization)
    escrow = create(:escrow, organization: organization)
    legal_entity = create(:legal_entity, :corporation, escrow: escrow, customer_type: 'buyer')

    form = described_class.new(
      legal_entity: legal_entity,
      relationship_type: LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory],
      ownership_params: { first_name: '', email: 'invalid' }
    )

    expect(CreateLegalOwnershipService).not_to receive(:call)
    expect(form.save).to be_falsey
  end

  it 'implements ActiveModel interface for form compatibility' do
    organization = create(:organization)
    escrow = create(:escrow, organization: organization)
    legal_entity = create(:legal_entity, :corporation, escrow: escrow, customer_type: 'buyer')

    form = described_class.new(
      legal_entity: legal_entity,
      relationship_type: LegalOwnership::RELATIONSHIP_TYPES[:authorized_signatory],
      ownership_params: {}
    )

    expect(form).not_to be_persisted
    expect(form.to_key).to be_nil
    expect(form.to_param).to be_nil
    expect(form.model_name.name).to eq('legal_ownership_form')
  end
end